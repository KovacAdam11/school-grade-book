{% extends "layout.html.njk" %}

{% block title %}
{{ classSubject.subject_name }} – {{ classSubject.grade_year }}.{{ classSubject.name_letter }}
{% endblock %}

{% macro sortLink(col) %}
    {% set nextDir = 'ASC' %}
    {% if sort == col and dir == 'ASC' %}
        {% set nextDir = 'DESC' %}
    {% endif %}
    ?sort={{ col }}&dir={{ nextDir }}
{% endmacro %}

{% block content %}

<a href="/teacher" class="btn btn-link mb-3">
    ← späť na moje predmety
</a>

<h2 class="mb-4">
    {{ classSubject.subject_name }}
    <small class="text-muted">
        — {{ classSubject.grade_year }}.{{ classSubject.name_letter }}
    </small>
</h2>

{% if flash.error %}
    <div class="alert alert-danger">
        {{ flash.error[0] }}
    </div>
{% endif %}

{% if flash.success %}
    <div class="alert alert-success">
        {{ flash.success[0] }}
    </div>
{% endif %}

<table class="table table-striped table-bordered align-middle">
    <thead class="table-light">
        <tr>
            <th>
                <a href="{{ sortLink('last_name') }}" class="text-decoration-none">
                    Žiak
                    {% if sort == 'last_name' %}
                        {% if dir == 'ASC' %}▲{% else %}▼{% endif %}
                    {% endif %}
                </a>
            </th>

            <th class="text-center">
                <a href="{{ sortLink('last_grade') }}" class="text-decoration-none">
                    Posledná známka
                    {% if sort == 'last_grade' %}
                        {% if dir == 'ASC' %}▲{% else %}▼{% endif %}
                    {% endif %}
                </a>
            </th>

            <th>
                <a href="{{ sortLink('last_graded_at') }}" class="text-decoration-none">
                    Dátum
                    {% if sort == 'last_graded_at' %}
                        {% if dir == 'ASC' %}▲{% else %}▼{% endif %}
                    {% endif %}
                </a>
            </th>

            <th style="width: 420px;">Akcie</th>
        </tr>
    </thead>

    <tbody>
    {% for s in students %}
        <tr>
            <td>{{ s.last_name }} {{ s.first_name }}</td>

            <td class="text-center">
                {% if s.last_grade %}
                    {{ s.last_grade }}
                {% else %}
                    -
                {% endif %}
            </td>

            <td>
                {% if s.last_graded_at %}
                    {{ s.last_graded_at | formatDate("dd.MM.yyyy HH:mm") }}
                {% else %}
                    -
                {% endif %}
            </td>

            <td>
                <form method="post"
                      action="/teacher/grade/add"
                      class="d-flex gap-2 mb-1">

                    <input type="hidden"
                           name="enrollment_id"
                           value="{{ s.enrollment_id }}">

                    <select name="grade_value"
                            class="form-select form-select-sm"
                            required>
                        <option value="">Známka</option>
                        {% for i in [1,2,3,4,5] %}
                            <option value="{{ i }}">{{ i }}</option>
                        {% endfor %}
                    </select>

                    <input type="text"
                           name="note"
                           class="form-control form-control-sm"
                           placeholder="Poznámka (voliteľné)">

                    <button type="submit"
                            class="btn btn-success btn-sm">
                        Pridať
                    </button>
                </form>

                <a href="/teacher/enrollment/{{ s.enrollment_id }}/grades"
                   class="btn btn-outline-secondary btn-sm">
                    História známok
                </a>
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>

{% endblock %}
