{% extends "layout.html.njk" %}
{% block title %}Správa predmetov{% endblock %}

{% block content %}

<h1 class="mb-4">Správa predmetov</h1>

<p class="text-muted mb-4">
    Na tejto stránke môžeš vytvárať, upravovať a odstraňovať predmety.
</p>

{% if flash.error %}
    <div class="alert alert-danger">{{ flash.error[0] }}</div>
{% endif %}
{% if flash.success %}
    <div class="alert alert-success">{{ flash.success[0] }}</div>
{% endif %}

<div class="card mb-4">
    <div class="card-header fw-bold">Pridať nový predmet</div>
    <div class="card-body">
        <form method="post" action="/admin/subjects/create" class="d-flex gap-2">
            <input type="text" name="name" class="form-control" required>
            <button class="btn btn-success">Pridať</button>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-header fw-bold">Existujúce predmety</div>

    <div class="card-body p-0">
        <table class="table table-striped table-bordered mb-0 align-middle">
            <thead class="table-light">
                <tr>
                    <th>ID</th>
                    <th>Názov predmetu</th>
                    <th class="text-center">Počet priradení</th>
                    <th style="width:280px">Akcie</th>
                </tr>
            </thead>

            <tbody>
            {% for s in subjects %}
                <tr>
                    <td>{{ s.id }}</td>

                    <td>
                        <form method="post"
                              action="/admin/subjects/{{ s.id }}/edit"
                              class="d-flex gap-2">
                            <input type="text"
                                   name="name"
                                   value="{{ s.name }}"
                                   class="form-control form-control-sm"
                                   required>
                            <button class="btn btn-sm btn-primary">Uložiť</button>
                        </form>
                    </td>

                    <td class="text-center">{{ s.usage_count }}</td>

                    <td class="text-center">
                        {% if s.usage_count > 0 %}
                            <button type="button"
                                    class="btn btn-sm btn-info me-1"
                                    onclick="showSubjectDetails({{ s.id }})">
                                Detaily
                            </button>

                            <button class="btn btn-sm btn-secondary" disabled>
                                Zmazať
                            </button>
                        {% else %}
                            <form method="post"
                                  action="/admin/subjects/{{ s.id }}/delete"
                                  style="display:inline"
                                  onsubmit="return confirm('Naozaj zmazať predmet {{ s.name }}?');">
                                <button class="btn btn-sm btn-danger">Zmazať</button>
                            </form>
                        {% endif %}
                    </td>
                </tr>
            {% else %}
                <tr>
                    <td colspan="4" class="text-center text-muted py-4">
                        Žiadne predmety
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- MODAL – DETAILY -->
<div class="modal fade" id="subjectModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Použitie predmetu</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div id="subject-details-content">Načítavam…</div>
            </div>

            <div class="modal-footer">
                <button type="button"
                        class="btn btn-outline-danger"
                        onclick="clearAssignments()">
                    Zmazať priradenia k triedam
                </button>

                <button type="button"
                        class="btn btn-danger"
                        onclick="clearEnrollments()">
                    Zmazať zápisy žiakov
                </button>

                <button type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal">
                    Zavrieť
                </button>
            </div>

        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
let currentSubjectId = null;

async function showSubjectDetails(id) {
    currentSubjectId = id;

    const res = await fetch(`/admin/subjects/${id}/details`);
    const data = await res.json();

    let html = '';

    if (data.length === 0) {
        html = '<p class="text-muted">Predmet nie je nikde použitý.</p>';
    } else {
        html += '<ul class="list-group">';
        data.forEach(row => {
            html += `
                <li class="list-group-item">
                    <strong>Trieda:</strong> ${row.class_name}<br>
                    <strong>Učiteľ:</strong> ${row.teacher_name}<br>
                    <strong>Počet žiakov:</strong> ${row.student_count}
                </li>
            `;
        });
        html += '</ul>';
    }

    document.getElementById('subject-details-content').innerHTML = html;
    new bootstrap.Modal(document.getElementById('subjectModal')).show();
}

async function clearAssignments() {
    if (!confirm('Naozaj chceš zmazať všetky priradenia predmetu k triedam?')) return;

    await fetch(`/admin/subjects/${currentSubjectId}/clear-assignments`, {
        method: 'POST'
    });

    location.reload();
}

async function clearEnrollments() {
    if (!confirm('Naozaj chceš zmazať VŠETKY zápisy žiakov na tento predmet?')) return;

    const res = await fetch(`/admin/subjects/${currentSubjectId}/clear-enrollments`, {
        method: 'POST'
    });

    const data = await res.json().catch(() => ({}));

    if (!res.ok || !data.ok) {
        alert(data.error || 'Chyba pri mazaní zápisov.');
        return;
    }

    location.reload();
}
</script>

{% endblock %}
